<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>管理中心</title>
    <link rel="stylesheet" href="res/css/common.css">
    <link rel="stylesheet" href="res/plugin/bootstrap.min.css">
    <style>
        th{
            background-color: #e6e6e6;
        }
        li:hover{
            background-color: black;
            color: white;
        }
        .user, .changePwd, .goBackHome{
            float: right;
            text-decoration: none;
            margin-right: 20px;
            line-height: 60px;
        }
        .user{
            color: darkturquoise;
        }
        .changePwd{
            color:  #8B7B8B;
        }
        .body-left{
            width: 200px;
            height: 540px;
            float: left;
            border-right: 1px solid #ccc;
        }
        .body-right{
            height: 540px;
            width: 1220px;
            float: left;
        }
        .body-left-top{
            height: 60px;
            background-color: #ccc;
        }
        .body-left-bottom{
            height: 480px;
        }
        .body-right-top{
            height: 60px;
            border-bottom: 1px solid #ccc;
        }
        .body-right-bottom{
            height: 480px;
        }
        .userManage, .resourceManage, .departManage{
            height: 480px;
            width: 1220px;
            overflow-y: scroll;
        }
        .addUser, .addResource, .addDepartment{
            height: 300px;
            width: 600px;
            background-color: white;
            position: fixed;
            left: 400px;
            top: 200px;
            background-color: #d9edf7;
            border-radius: 20px;
        }
        .add-headline{
            height:50px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            line-height: 50px;
        }
        .add-body{
            text-align: center;
            height: 200px;
        }
        .add-foot{
            height: 50px;
            text-align: center;
        }
        .addWinBtn{
            margin-left:40px;
        }
        .body-headline{
            display: block;
            font-size: 22px;
            padding-left: 13px;
            padding-top: 15px;
            color: #444444;
        }
        .manage-headline{
            margin-left: 30px;
            line-height: 60px;
            font-size: 20px;
            color: #31b0d5;
        }
        .keywords{
            color: #31b0d5;
            font-size: 14px;
            margin-left: 200px;
        }
        #search {
            height: 40px;
            width: 400px;
            margin-right: 20px;
            margin-top: 10px;
        }
        .searchBtn, .addWinBtn{
            display: inline-block;
            outline: none;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            font: 14px/100% Arial, Helvetica, sans-serif;
            padding: .5em 2em .55em;
            margin-right: 20px;
            text-shadow: 0 1px 1px rgba(0,0,0,.3);
            -webkit-border-radius: .5em;
            -moz-border-radius: .5em;
            border-radius: .5em;
            -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.2);
            -moz-box-shadow: 0 1px 2px rgba(0,0,0,.2);
            box-shadow: 0 1px 2px rgba(0,0,0,.2);
        }
        .addBtn{
            height: 30px;
            width: 100px;
            background-color: #333333;
            color: white;
        }
        .searchBtn:hover, .addBtn:hover {
            text-decoration: none;
        }
        .searchBtn:active, .addBtn:active {
            position: relative;
            top: 1px;
        }
    </style>
</head>
<body>
    <div>
        <div class="head" id="head">
            <span class="headline">资源分享系统</span>
            <a href="/" class="goBackHome">返回主页</a>
            <a href="javascripe:;" class="changePwd">修改密码</a>
            <a href="javascript:;" class="user">{{welcome}}</a>
        </div>
        <div class="canvas">
            <canvas id="cas"></canvas>
        </div>
        <div class="body" id="body">
            <div class="body-left">
                <div class="body-left-top">
                    <span class="body-headline">管理中心</span>
                </div>
                <div class="body-left-bottom">
                    <ul class="manageMenu">
                        <li>部门管理</li>
                        <li>用户管理</li>
                        <li>资源管理</li>
                    </ul>
                </div>
            </div>
            <div class="body-right">
                <div class="body-right-top" v-show="rightHeadShow">
                    <span class="manage-headline">{{chosedManage}}</span>
                    <button class="addBtn" @click="addWinShow">{{addBtn}}</button>
                    <span class="keywords">关键字:{{keywords}}</span>
                    <label for="search">
                        <input type="text" id="search" placeholder="请输入" @keyup.13="search">
                    </label>
                    <button class="searchBtn" @click="search" >搜索</button>
                    <a href="javascript:;" class="cancel" @click="cancelSearch">取消</a>
                </div>
                <div class="body-right-bottom">
                    <div class="tab">
                        <div class="resourceManage" v-show="resourceShow">
                            <table class="table">
                                <tr>
                                    <th>资源名称</th>
                                    <th>资源类型</th>
                                    <th>资源大小</th>
                                    <th>资源路径</th>
                                    <th>资源分组</th>
                                    <th>所属人</th>
                                    <th>资源描述</th>
                                    <th>操作</th>
                                </tr>
                                <tr v-for="(resource,index) in resources" v-show="resource.isshow">
                                    <td>{{resource.resource_name}}</td>
                                    <td>{{resource.resource_type}}</td>
                                    <td>{{resource.resource_size}}</td>
                                    <td>{{resource.resource_path}}</td>
                                    <td>{{resource.resource_group}}</td>
                                    <td>{{resource.resource_owner}}</td>
                                    <td>{{resource.resource_desc}}</td>
                                    <td><a href="javascript:;" @click="changeResource">修改</a>&nbsp;<a href="javascript:;" @click="deleteResource(index)">删除</a></td>
                                </tr>
                            </table>
                        </div>
                        <div class="userManage" v-show="userShow">
                            <table class="table">
                                <tr>
                                    <th>用户名称</th>
                                    <th>用户账号</th>
                                    <th>用户密码</th>
                                    <th>用户角色</th>
                                    <th>所属部门</th>
                                    <th>所属分组</th>
                                    <th>操作</th>
                                </tr>
                                <tr v-for="(user,index) in users" v-show="user.isshow">
                                    <td>{{user.user_name}}</td>
                                    <td>{{user.user_account}}</td>
                                    <td>{{user.user_password}}</td>
                                    <td>{{user.user_role}}</td>
                                    <td>{{user.user_department}}</td>
                                    <td>{{user.user_group}}</td>
                                    <td><a href="javascript:;">修改</a>&nbsp;<a href="javascript:;" @click="deleteUser(index)">删除</a></td>
                                </tr>
                            </table>
                        </div>
                        <div class="departManage" v-show="departShow">
                            <table class="table">
                                <tr>
                                    <th>部门ID</th>
                                    <th>部门名称</th>
                                    <th>上级部门</th>
                                    <th>操作</th>
                                </tr>
                                <tr v-for="department in departments" v-show="department.isshow">
                                    <td>{{department.department_id}}</td>
                                    <td>{{department.department_name}}</td>
                                    <td>{{department.department_highDepart}}</td>
                                    <td><a href="javascript:;">修改</a>&nbsp;<a href="javascript:;">删除</a></td>
                                </tr>
                            </table>
                        </div>
                        <div class="addUser" v-show="addUserWin">
                            <div class="add-headline">添加用户</div>
                            <div class="add-body">
                                <label for="newUserName">
                                    用户名称: <input type="text" id="newUserName">
                                </label>
                                <label for="newUserAccount">
                                    用户账号: <input type="text" id="newUserAccount">
                                </label>
                                <label for="newUserPassword">
                                    用户密码: <input type="text" id="newUserPassword">
                                </label>
                                <label for="newUserRole">
                                    用户角色: <input type="text" id="newUserRole">
                                </label>
                                <label for="newUserDepartment">
                                    所在部门: <input type="text" id="newUserDepartment">
                                </label>
                                <label for="newUserGroup">
                                    所在分组: <input type="text" id="newUserGroup">
                                </label>
                            </div>
                            <div class="add-foot">
                                <button class="addWinBtn" @click="submitConfirm">确定</button>
                                <button class="addWinBtn" @click="addWinHide">取消</button>
                            </div>
                        </div>
                        <div class="addResource" v-show="addResourceWin">
                            <div class="add-headline">添加资源</div>
                            <div class="add-body">
                                <form action="/upload" method="post" enctype="multipart/form-data">
                                    <label for="newResourceDesc">
                                        资源描述: <input type="text" id="newResourceDesc" name="newResourceDesc">
                                    </label>
                                    <label for="newResourceOwner">
                                        资源所属人: <input type="text" id="newResourceOwner" name="newResourceOwner">
                                    </label>
                                    <label for="newResourceDepart">
                                        资源所属部门: <input type="text" id="newResourceDepart" name="newResourceDepart">
                                    </label>
                                    <label for="newResourceGroup">
                                        资源所属组别: <input type="text" id="newResourceGroup" name="newResourceGroup">
                                    </label>
                                    <label for="newResource">
                                        <input type="file" id="newResource" name="newResource">
                                    </label>
                                </form>
                            </div>
                            <div class="add-foot">
                                <button class="addWinBtn"  @click="submitConfirm">确定</button>
                                <button class="addWinBtn" @click="addWinHide">取消</button>
                            </div>
                        </div>
                        <div class="addDepartment" v-show="addDepartmentWin">
                            <div class="add-headline">添加部门</div>
                            <div class="add-body">
                                
                            </div>
                            <div class="add-foot">
                                <button class="addWinBtn" @click="submitConfirm">确定</button>
                                <button class="addWinBtn" @click="addWinHide">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="foot">
            <a href="javascript:;" class="bottom">copyright@hzlh</a><br/>
            <a href="javascript:;" class="bottom">联系我们</a><br/>
            <a href="javascript:;" class="bottom">QQ:XXXXXXXXX</a>
            <a href="javascript:;" class="bottom">邮箱:XXXXXXXXXX</a>
        </div>
    </div>
    <script src="res/plugin/jquery-3.2.1.min.js" type="text/javascript"></script>
    <script src="res/plugin/jquery.form.js" type="text/javascript"></script>
    <script src="res/plugin/vue.js"></script>
    <script>
        !function() {
            var canvas = document.getElementById('cas');
            var ctx = canvas.getContext('2d');
            var rgb = '0';      // 线条颜色值
            var extendDis = 5;   // 可超出的画布边界
            var lineDis = 100;    // 连线距离
            lineDis *= lineDis;
            canvas.width = 1422;
            canvas.height = 85;
            var RAF = (function() {
                return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
            })();
            // 鼠标活动时，获取鼠标坐标
            var warea = {x: null, y: null};
            window.onmousemove = function(e) {
                e = e || window.event;
                warea.x = e.clientX - canvas.offsetLeft;
                warea.y = e.clientY - canvas.offsetTop;
            };
            window.onmouseout = function(e) {
                warea.x = null;
                warea.y = null;
            };
            // 添加粒子
            // x，y为粒子坐标，xa, ya为粒子xy轴加速度，max为连线的最大距离
            var dots = [];
            for (var i = 0; i < 150; i++) {
                var x = Math.random() * (canvas.width + 2 * extendDis) - extendDis;
                var y = Math.random() * (canvas.height + 2 * extendDis) - extendDis;
                var xa = (Math.random() * 2 - 1) / 1.5;
                var ya = (Math.random() * 2 - 1) / 1.5;
                dots.push({
                    x: x,
                    y: y,
                    xa: xa,
                    ya: ya
                })
            }
            // 延迟100秒开始执行动画，如果立即执行有时位置计算会出错
            setTimeout(function() {
                animate();
            }, 100);
            // 每一帧循环的逻辑
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                bubDrawLine([warea].concat(dots));
                RAF(animate);
            }
            /**
             * 逐个对比连线
             * @param ndots
             */
            function bubDrawLine(ndots) {
                var ndot;
                dots.forEach(function(dot) {
                    move(dot);
                    // 循环比对粒子间的距离
                    for (var i = 0; i < ndots.length; i++) {
                        ndot = ndots[i];
                        if (dot === ndot || ndot.x === null || ndot.y === null) continue;
                        var xc = dot.x - ndot.x;
                        var yc = dot.y - ndot.y;
                        // 如果x轴距离或y轴距离大于max,则不计算粒子距离
                        if (xc > ndot.max || yc > lineDis) continue;
                        // 两个粒子之间的距离
                        var dis = xc * xc + yc * yc;
                        // 如果粒子距离超过max,则不做处理
                        if (dis > lineDis) continue;
                        // 距离比
                        var ratio;
                        // 如果是鼠标，则让粒子向鼠标的位置移动
                        if (ndot === warea && dis < 20000) {
                            dot.x -= xc * 0.01;
                            dot.y -= yc * 0.01;
                        }
                        // 计算距离比
                        ratio = (lineDis - dis) / lineDis;
                        // 粒子间连线
                        ctx.beginPath();
                        ctx.lineWidth = ratio / 2;
                        ctx.strokeStyle = 'rgba(' + rgb + ', ' + rgb + ', ' + rgb + ', 1';
                        ctx.moveTo(dot.x, dot.y);
                        ctx.lineTo(ndot.x, ndot.y);
                        ctx.stroke();
                    }
                    // 将已经计算过的粒子从数组中删除
                    ndots.splice(ndots.indexOf(dot), 1);
                });
            }
            /**
             * 粒子移动
             * @param dot
             */
            function move(dot) {
                dot.x += dot.xa;
                dot.y += dot.ya;
                // 遇到边界将加速度反向
                dot.xa *= (dot.x > (canvas.width + extendDis) || dot.x < -extendDis) ? -1 : 1;
                dot.ya *= (dot.y > (canvas.height + extendDis) || dot.y < -extendDis) ? -1 : 1;
                // 绘制点
                ctx.fillStyle = 'rgba(' + rgb + ', ' + rgb + ', ' + rgb + ', 1';
                ctx.fillRect(dot.x - 0.5, dot.y - 0.5, 1, 1);
            }
        }();
        var head = new Vue({
            el: '#head',
            data: {
                welcome: 'hh'
            },
            methods:{

            },
            mounted: function(){
                $.ajax({
                   type: "GET",
                   url: "/manageSession",
                   dataType: "json",
                   async: true,
                   error: function(obj,err){
                       console.log("请求失败:"+err);
                   },
                   success: function(data){
                       if(!data.hasOwnProperty("account")){
                           head.welcome = "请先登录";
                       }else{
                           head.welcome = "欢迎"+data.account;
                       }
                   }
                });
            }
        });
        var body = new Vue({
           el: '#body',
           data: {
               addUserWin : false,
               addDepartmentWin: false,
               addResourceWin: false,
               addBtn: '',
               keywords: '',
               rightHeadShow: false,
               chosedManage: '',
               departShow: false,
               resourceShow: false,
               userShow: false,
               resources: [],
               departments: [],
               users: []
           },
           methods: {
               search: function(){
                   var searchContent = $("#search").val();
                   if(body.chosedManage=="部门管理"){
                        for(d of body.departments){
                            if(d.department_name.indexOf(searchContent)==-1){
                                d.isshow = false;
                            }else{
                                d.isshow = true;
                            }
                        }
                   }else if(body.chosedManage=="用户管理"){
                        for(u of body.users){
                            if(u.user_name.indexOf(searchContent)==-1){
                                u.isshow = false;
                            }else{
                                u.isshow = true;
                            }
                        }
                   }else if(body.chosedManage=="资源管理"){
                       for(r of body.resources){
                           if(r.resource_name.indexOf(searchContent)==-1){
                               r.isshow = false;
                           }else{
                               r.isshow = true;
                           }
                       }
                   }
               },
               cancelSearch: function(){
                   for(r of recData){
                       r.isshow = true;
                   }
                   $("#search").val("");
               },
               addWinShow: function(){
                   if(body.chosedManage=="部门管理"){
                        body.addUserWin = false;
                        body.addDepartmentWin = true;
                        body.addResourceWin = false;
                   }else if(body.chosedManage=="用户管理"){
                       $(".addUser input").val("");
                       body.addUserWin = true;
                       body.addDepartmentWin = false;
                       body.addResourceWin = false;
                   }else if(body.chosedManage=="资源管理"){
                       $(".addResource input").val("");
                       body.addUserWin = false;
                       body.addDepartmentWin = false;
                       body.addResourceWin = true;
                   }
               },
               addWinHide: function(){
                   body.addUserWin = false;
                   body.addResourceWin = false;
                   body.addDepartmentWin = false;
               },
               submitConfirm: function(){
                   let reg = /^[0-9a-zA-Z]+$/;
                    if(body.addUserWin){
                        if($("#newUserName").val()!==""){
                            if($("#newUserAccount").val()!==""){
                                if(reg.test($("#newUserPassword").val())){
                                    var jsonObj = {
                                        "name" : $("#newUserName").val(),
                                        "account" : $("#newUserAccount").val(),
                                        "password" : $("#newUserPassword").val(),
                                        "role" : $("#newUserRole").val(),
                                        "group" : $("#newUserGroup").val(),
                                        "department" : $("#newUserDepartment").val()
                                    };
                                    let jsonStr = JSON.stringify(jsonObj);
                                    $.ajax({
                                        type: 'POST',
                                        url: '/addUser',
                                        contentType: "application/json",
                                        data: jsonStr,
                                        dataType: 'text',
                                        async: true,
                                        error: function (obj,err) {
                                            console.log("请求失败:"+err);
                                        },
                                        success: function(data){
                                            console.log("请求成功:"+data);
                                            if(data=="用户名称已存在,请重新输入"){
                                                alert(data);
                                                $("#newUserName").val("");
                                            }else if(data=="用户账号已存在,请重新输入"){
                                                alert(data);
                                                $("#newUserAccount").val("");
                                            }else{
                                                alert(data);
                                                body.addWinHide();
                                                getData(body.chosedManage);
                                            }
                                        }
                                    });
                                }else{
                                    $("#newUserPassword").val("");
                                    alert("密码中有非法字符或为空,请重新输入");
                                }
                            }else{
                                alert("用户账号不能为空,请重新输入");
                            }
                        }else{
                            alert("用户名称不能为空,请重新输入");
                        }
                    }else if(body.addResourceWin){
                        $('form').ajaxSubmit({
                            type: 'POST',
                            url: 'upload',
                            dataType: 'text',
                            success: function(data){
                                if(data==="error"){
                                    alert("上传失败!");
                                }else{
                                    alert("上传成功!");
                                    body.addWinHide();
                                    getData(body.chosedManage);
                                }
                            }
                        });
                    }else if(body.addDepartmentWin){

                    }
               },
               deleteUser: function(index){
                   $.ajax({
                       type: 'POST',
                       url: '/deleteUser',
                       contentType: 'application/json ',
                       data: body.users[index].user_id.toString(),
                       async: true,
                       error: function(obj,err){
                           console.log('请求失败:'+err);
                       },
                       success: function(data){
                           body.users[index].isshow = false;
                           alert(data);
                       }
                   })
               },
               deleteResource: function(index){
                   let jsonObj = {
                       "id" : body.resources[index].resource_id,
                       "path" : body.resources[index].resource_path,
                       "name" : body.resources[index].resource_name,
                       "type" : body.resources[index].resource_type
                   };
                   let jsonStr = JSON.stringify(jsonObj);
                    $.ajax({
                        type: 'POST',
                        url: '/deleteResource',
                        contentType: 'application/json',
                        data: jsonStr,
                        async: true,
                        error: function(obj,err){
                            console.log('请求失败:'+err);
                        },
                        success: function(data){
                            if(data==="删除成功"){
                                body.resources[index].isshow = false;
                            }
                            alert(data);
                        }
                    });
               }
           }
        });
        $("li").click(function(){
            body.rightHeadShow = true;
            var chooseManage = $(this).text();
            getData(chooseManage);
            body.chosedManage = chooseManage;
            if(chooseManage=="部门管理"){
                body.addWinHide();
                $("#search").val("");
                body.keywords = "部门名称"
                body.addBtn = "添加部门";
                body.departShow = true;
                body.resourceShow = false;
                body.userShow = false;
            }else if(chooseManage=="用户管理"){
                body.addWinHide();
                $("#search").val("");
                body.keywords = "用户名称";
                body.addBtn = "添加用户";
                body.departShow = false;
                body.resourceShow = false;
                body.userShow = true;
            }else if(chooseManage=="资源管理"){
                body.addWinHide();
                $("#search").val("");
                body.keywords = "资源名称 资源分组";
                body.addBtn = "上传资源";
                body.departShow = false;
                body.resourceShow = true;
                body.userShow = false;
            }
        })
        //获取用户，资源或者部门数据并刷新
        function getData(chosed){
            $.ajax({
                type: 'POST',
                url: '/getData',
                contentType: "text/plain",
                data: chosed,
                dataType: 'json',
                async: true,
                error: function(obj,err){
                    console.log('请求失败:'+err);
                },
                success: function(data){
                    recData = eval("("+JSON.stringify(data)+")");
                    for(d of recData){
                        d.isshow = true;
                    }
                    console.log('getData:'+ recData);
                    if(recData[0].hasOwnProperty("resource_id")){
                        body.resources = recData;
                    }else if(recData[0].hasOwnProperty("user_id")){
                        body.users = recData;
                    }else if(recData[0].hasOwnProperty("department_id")){
                        body.departments = recData;
                    }
                }
            });
        }
    </script>
</body>
</html>